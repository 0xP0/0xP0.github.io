<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日志查看器</title>
    <!-- 引入 Bootstrap v3 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
        .pagination-container {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        .page-skip {
          cursor: pointer;
        }
        .count-container {
          display: inline-block;
          margin-left: 15px;
          padding: 5px 10px;
          font-size: 16px;
          color: #fff;
          background-color: #337ab7;
          border-radius: 5px;
      }

    </style>
</head>
<body>

<div class="container">
    <h4>日志<span id="logCount" class="count-container">0</span></h4>
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>操作</th>
                    <th>创建时间</th>
                    <th>内容</th>
                </tr>
            </thead>
            <tbody id="logsTableBody">
                <!-- 表格行将在这里添加 -->
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <!-- 分页按钮将在这里添加 -->
            </ul>
        </nav>
    </div>
</div>

<script>
    let currentPage = 0;
    let recordsPerPage = 8;
    let totalPages = 0;

    function fetchTotalRecordsAndLogs() {
        fetch("//frp.sjtuee.net/handler/count")
            .then(response => response.json())
            .then(data => {
                const totalRecords = data.count;
                totalPages = Math.ceil(totalRecords / recordsPerPage);
                fetchAndDisplayLogs(currentPage);
                updatePagination();
            })
            .catch(error => {
                console.error('Error fetching total records:', error);
            });
    }

      function updateLogCount() {
        fetch("//frp.sjtuee.net/handler/count")
            .then(response => response.json())
            .then(data => {
                document.getElementById('logCount').textContent = data.count;
            })
            .catch(error => {
                console.error('Error fetching log count:', error);
            });
    }

    // 首次加载时更新计数器
    updateLogCount();

    // 每5秒更新一次计数器
    setInterval(updateLogCount, 2000);


    function fetchAndDisplayLogs(page) {
        fetch(`//frp.sjtuee.net/handler/logs?page=${page}&size=${recordsPerPage}&order=DESC`)
            .then(response => response.json())
            .then(data => {
                const logsTableBody = document.getElementById('logsTableBody');
                logsTableBody.innerHTML = ''; // 清除现有的表格行
                data.logs.forEach(log => {
                    const row = logsTableBody.insertRow();
                    const cellId = row.insertCell();
                    const cellOp = row.insertCell();
                    const cellCreateTime = row.insertCell();
                    const cellContent = row.insertCell();
                    cellId.textContent = log.id;
                    cellOp.textContent = log.op;
                    cellCreateTime.textContent = formatDate(log.create_time);
                    cellContent.textContent = JSON.stringify(log.body);
                });
            })
            .catch(error => {
                console.error('Error fetching logs:', error);
            });
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString('zh-CN', { hour12: false });
    }

    function updatePagination() {
      const pagination = document.querySelector('.pagination');
      pagination.innerHTML = ''; // 清除现有的分页按钮

      const createPageItem = (page, text) => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="#">${text}</a>`;
          if (page === currentPage) {
              li.classList.add('active');
          } else {
              li.onclick = () => goToPage(page);
          }
          return li;
      };

      // 首页
      pagination.appendChild(createPageItem(0, '首页'));

      // 上一页
      pagination.appendChild(createPageItem(Math.max(currentPage - 1, 0), '&laquo;'));

      // 快速向后（如果需要）
      if (currentPage > 7) {
          pagination.appendChild(createPageItem(currentPage - 5, '...'));
      }

      // 中间页码
      const startPage = Math.max(currentPage - 7, 0);
      const endPage = Math.min(startPage + 14, totalPages - 1);
      for (let i = startPage; i <= endPage; i++) {
          pagination.appendChild(createPageItem(i, i + 1));
      }

      // 快速向前（如果需要）
      if (currentPage < totalPages - 8) {
          pagination.appendChild(createPageItem(currentPage + 5, '...'));
      }

      // 下一页
      pagination.appendChild(createPageItem(Math.min(currentPage + 1, totalPages - 1), '&raquo;'));

      // 尾页
      pagination.appendChild(createPageItem(totalPages - 1, '尾页'));

      // 禁用首尾页按钮时的条件
      pagination.children[0].classList.toggle('disabled', currentPage === 0);
      pagination.lastChild.classList.toggle('disabled', currentPage === totalPages - 1);
  }


    function goToPage(page) {
        if (page >= 0 && page < totalPages) {
            currentPage = page;
            fetchAndDisplayLogs(page);
            updatePagination();
        }
    }

    document.addEventListener('DOMContentLoaded', fetchTotalRecordsAndLogs
    );

  </script>
  
  </body>
  </html>
